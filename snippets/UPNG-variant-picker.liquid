

{%- comment -%}
  ***** UPANGO *****

    VARIANT PICKER BASADO EN ORIGINAL DE TEMA ENTERPRISE:
    - Integra una tabla de variantes con imÃ¡genes en la que cada fila serÃ¡ una variante option1-option2 (Ejemplo Color - Talla)
    - Esta tabla FuncionarÃ¡ como ** Listado de Pedidos RÃ¡pidos **
    - Opcion de Custom Swatch para mostrar 'Icono personalizado' para cada variante desde Metacampo

    INTEGRA LAS FUNCIONES DE:
    - Refrescar Product Media al cambiar option1 de Variante (Color)
    - Mostrar / Ocultar filas de la tabla, dependiendo del option1 de Variante (Color) seleccionado
    - Sincronizacion con el carrito en el Input Quantity
    - Activar 'Custom Swatch' desde Settings de Tema

  ***** UPANGO *****

    Parameters:
    - product {Object} - Product object.
    - product_form_id {String} - Product form ID.
    - media_ratio {Number} - Media aspect ratio.
    - swatch_crop {Object} - Alignment of image in variant image swatches.
    - block {Object} - Block object.
    - update_url {Boolean} - Update the URL when selecting a variant (optional, default is false).

    Dependencies:
    - Custom select component

    Usage:
    {% render 'variant-picker', product: product, product_form_id: product_form_id, block: block %}
{%- endcomment -%}

<link rel="stylesheet" href="{{ 'UPNG-variant-picker.css' | asset_url }}">
<script src="{{ 'UPNG-variant-picker.js' | asset_url }}" defer="defer"></script>

{%- liquid
  # Selección de Variante
  if section.settings.select_first_variant or product.variants.size == 1 or product.selected_variant
    assign variant_is_selected = true
  endif

  # Actualizar URL
  assign update_url = update_url | default: false, allow_false: true

  # Capturar collection 'outlet'
  assign current_collection = collection.handle
  assign is_outlet = false
  if current_collection == 'outlet'
    assign is_outlet = true
  endif
%}

{%- if block.settings.enable_size_chart -%}
  <link rel="stylesheet" href="{{ 'modal.css' | asset_url }}">
{%- endif -%}

{%- if block.settings.selector_style == 'dropdown' -%}
  <script src="{{ 'custom-select.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{% comment %} Desde liquid: {{ is_outlet }} {% endcomment %}

<upng-variant-picker
  {% if context %}
    data-context="{{ context }}"
  {% endif %}
  class="no-js-hidden"
  data-url="{{ product.url }}"
  data-update-url="{{ update_url }}"
  data-select-first-variant="{{ section.settings.select_first_variant }}"
  data-show-availability="{{ block.settings.enable_dynamic_availability }}"
  data-availability-method="{% if block.settings.dynamic_availability_downwards or section.settings.select_first_variant == false %}downward{% else %}selection{% endif %}"
  {% if block.settings.selector_style == 'dropdown' %}
    data-placeholder-text="{{ "general.labels.please_select" | t | json }}"
  {% endif %}
>
  {%- for option in product.options_with_values -%}


    {%- capture option_id %}{{ section.id }}-{{ option.name | handle }}{% endcapture -%}
    {%- liquid
      assign is_color_selector = false
      assign is_swatch_style = false
      assign is_native_swatch_style = false
      assign is_variant_image_style = false
      assign show_size_chart = false

      # Nueva Opcion para Variantes con Imagenes Custom

      if settings.swatch_option_name contains option.name and settings.variant_picker_color_style == 'variant-images'
        assign is_color_selector = true
        assign is_variant_image_style = true
        assign option_index0 = forloop.index0
      elsif settings.swatch_option_name contains option.name and settings.variant_picker_color_style == 'upng-variant-images'
        assign is_color_selector = true
        assign is_variant_image_style = true
        assign is_upng_variant_image_style = true
        assign option_index0 = forloop.index0
      elsif settings.swatch_option_name contains option.name and settings.variant_picker_color_style == 'swatches'
        assign is_color_selector = true
        assign is_swatch_style = true
      elsif settings.variant_picker_color_style == 'native'
        assign native_swatch_options = option.values | where: 'swatch'
        if native_swatch_options.size > 0
          assign is_color_selector = true
          assign is_swatch_style = true
          assign is_native_swatch_style = true
        endif
      endif

      if block.settings.enable_size_chart and block.settings.size_chart_variant == option.name and block.settings.size_chart_page != blank
        assign show_size_chart = true
      endif
    -%}

    {%- if show_size_chart -%}
      {%- capture size_chart_link -%}
        <modal-opener class="no-js-hidden" data-modal="size-chart">
          <button type="button" class="link block text-sm" aria-haspopup="dialog">
            {{- 'products.product.size_chart' | t -}}
          </button>
        </modal-opener>
        <noscript>
          <a href="{{ block.settings.size_chart_page.url }}" class="link">{{ 'products.product.size_chart' | t }}</a>
        </noscript>
      {%- endcapture -%}
    {%- endif -%}

    {%- if block.settings.selector_style == 'dropdown'
      and is_variant_image_style == false
      and is_native_swatch_style == false
    -%}
      {%- capture selector_label -%}
        <label class="label" id="{{ option_id }}-label">{{- option.name -}}</label>
      {%- endcapture -%}
      <div class="option-selector" data-selector-type="dropdown">
        {%- if show_size_chart -%}
          <div class="flex justify-between">
            {{ selector_label }}
            {{ size_chart_link }}
          </div>
        {%- else -%}
          {{ selector_label }}
        {%- endif -%}
        {%- liquid
          if section.settings.select_first_variant or product.variants.size == 1
            assign selected_value = option.selected_value
          else
            if product.selected_variant
              assign selected_value = option.selected_value
            else
              assign selected_value = ''
            endif
          endif
        -%}
        {% render 'custom-select',
          id: option_id,
          option_values: option.values,
          selected_value: selected_value,
          swatches: is_swatch_style
        %}
      </div>
    {%- else -%}
      <fieldset class="option-selector" data-selector-type="listed">
        {%- if show_size_chart -%}
          <div class="flex justify-between">
            <legend class="label">
              {{- option.name -}}
              {% if is_color_selector and settings.variant_picker_color_style != 'text' -%}
                :
                <span class="option-selector__label-value js-color-text">
                  {%- if variant_is_selected %}{{ option.selected_value }}{% endif -%}
                </span>
              {%- endif %}
            </legend>
            {{ size_chart_link }}
          </div>
        {%- else -%}
          <legend class="label">
            {{- option.name -}}
            {% if is_color_selector and settings.variant_picker_color_style != 'text' -%}
              :
              <span class="option-selector__label-value js-color-text">
                {%- if variant_is_selected %}{{ option.selected_value }}{% endif -%}
              </span>
            {%- endif %}
          </legend>
        {%- endif -%}
        <div class="option-selector__btns flex flex-wrap{% if is_variant_image_style %} items-start{% endif %}">
          {%- for value in option.values -%}
            
            {% comment %}
             
            Recorrer TODAS las variantes, buscar el value y capturar metafields
            {% assign color_sin_outlet = true %}

                <!-- Variante TItulo: {{ value.variant.title }} | Descatalogado: {{ value.variant.metafields.upng.descatalogado }} -->
                <!--Value: {{ value.variant | json }} -->
                {% if value.variant.metafields.upng.descatalogado == true %}
                  {% assign color_sin_outlet = false %}
                  {% break %}
                {%  endif %}

            {% endcomment %}

            {%- assign value_index0 = forloop.index0 -%}
            <input
              data-firstvariant="{{ value.variant.id }}"
              type="radio"
              class="opt-btn visually-hidden focus-label js-option"
              name="{{ option_id }}-option"
              id="{{ option_id }}-opt-{{ value_index0 }}"
              value="{{ value | escape }}"
              {% if variant_is_selected and option.selected_value == value %}checked{% endif %}
            >

            {%- if is_variant_image_style -%}
              
                  <label
                    class="opt-label opt-label--swatch opt-label--image relative swatch-shape--{{ settings.variant_picker_swatch_shape }}{% if settings.variant_picker_swatch_shape != "circle" %} swatch-shape--not-circle{% endif %}{% if settings.variant_picker_color_style == 'variant-images' and value.variant.featured_media %} swatch--variant-image{% endif %}"
                    {% if value.variant.featured_media == blank %}
                      data-swatch="{{ value | replace: '"', '' | downcase }}"
                    {% endif %}
                    for="{{ option_id }}-opt-{{ value_index0 }}"
                    {% comment %} {% if is_outlet and color_sin_outlet %} style="display: none"{% endif %} Si es contexto oulet, y color No tiene, Oculta {% endcomment %}
                  >
                    <span class="visually-hidden js-value">{{- value | escape -}}</span>
                    <div class="opt-label__media media h-full w-full{% if settings.variant_picker_color_style == 'variant-images' and value.variant.featured_media == blank %} absolute top-0 left-0{% else %} relative{% endif %}">
                      {%- liquid
                        if settings.variant_picker_swatch_shape == 'natural'
                          assign class = 'bg-theme-bg'
                        elsif swatch_crop == 'top'
                          assign class = 'img-fit object-top bg-theme-bg'
                        else
                          assign class = 'img-fit bg-theme-bg'
                        endif

                        assign swatch_size = settings.variant_picker_swatch_size | times: 1.5
                      -%}
                      {%- liquid
                        # Renderizado condicional de la Imagen de la Variante Custom / o por Defecto del Tema (featured_media)
                        assign image_to_render = value.variant.featured_media
                        if settings.variant_picker_color_style == 'upng-variant-images' and value.variant.metafields.upng.icono_color != blank
                          assign image_to_render = value.variant.metafields.upng.icono_color.value
                        endif
                      -%}
                      <img src="{{image_to_render}}" class="{{class}}" loading="eager" />
                      {% comment %} {% render 'image',
                        image: image_to_render,
                        src_width: swatch_size,
                        lazy_load: false,
                        class: class,
                        disable_focal_point: true
                      %} {% endcomment %}
                    </div>
                  </label>

            {%- elsif settings.variant_picker_color_style == 'native' and value.swatch.image -%}
              {%- liquid
                assign multiplier = settings.variant_picker_swatch_size | at_least: 64
                assign image_width = value.swatch.image.aspect_ratio | at_least: 1.0 | times: multiplier | ceil
              -%}
              <label
                class="opt-label opt-label--swatch btn relative swatch--native swatch-shape--{{ settings.variant_picker_swatch_shape }}{% if settings.variant_picker_swatch_shape != "circle" %} swatch-shape--not-circle{% endif %}"
                for="{{ option_id }}-opt-{{ value_index0 }}"
                data-swatch
                {% comment %} {% if is_outlet and color_sin_outlet %} style="display: none"{% endif %} Si es contexto oulet, y color No tiene, Oculta {% endcomment %}
              >
                <span class="visually-hidden js-value">{{ value }}</span>
                {%- if settings.variant_picker_swatch_shape == 'natural' -%}
                  <div class="opt-label__native-media media">
                    {%- render 'image', image: value.swatch.image, src_width: image_width, srcset_2x: true -%}
                  </div>
                {%- else -%}
                  <div class="opt-label__native-media media absolute inset-0">
                    {%- render 'image',
                      image: value.swatch.image,
                      src_width: image_width,
                      srcset_2x: true,
                      class: 'img-fit'
                    -%}
                  </div>
                {%- endif -%}
              </label>

            {%- elsif settings.variant_picker_color_style == 'native' and value.swatch.color -%}
              <label
                class="opt-label opt-label--swatch btn relative swatch-shape--{{ settings.variant_picker_swatch_shape }}{% if settings.variant_picker_swatch_shape != "circle" %} swatch-shape--not-circle{% endif %}"
                data-swatch="{{ value | replace: '"', '' | downcase }}"
                for="{{ option_id }}-opt-{{ value_index0 }}"
                style="--swatch-color: rgb({{ value.swatch.color.rgb }});--swatch-image: none; "{% comment %} {% if is_outlet and color_sin_outlet %}display: none;{% endif %}"  Si es contexto oulet, y color No tiene, Oculta {% endcomment %}
              >
                <span class="visually-hidden js-value">{{ value }}</span>
              </label>

            {%- else -%}
              <label
                class="opt-label {% if is_color_selector and is_swatch_style %}opt-label--swatch swatch-shape--{{ settings.variant_picker_swatch_shape }}{% if settings.variant_picker_swatch_shape != "circle" %} swatch-shape--not-circle{% endif %}{% else %}opt-label--btn{% endif %} btn relative text-center"
                {% if is_color_selector and is_swatch_style %}
                  data-swatch="{{ value | replace: '"', '' | downcase }}"
                {% endif %}
                for="{{ option_id }}-opt-{{ value_index0 }}"
                {% comment %} {% if is_outlet and color_sin_outlet %} style="display: none"{% endif %} Si es contexto oulet, y color No tiene, Oculta {% endcomment %}
              >
                <span
                  {% if is_color_selector and is_swatch_style %}
                    class="visually-hidden js-value"
                  {% endif %}
                >
                  {{- value | escape -}}
                </span>
              </label>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </fieldset>
    {%- endif -%}
    {% comment %} No generar segundo fieldset {% endcomment %}
    {% break %}
  {%- endfor -%}
  <script type="application/json">
    {
      "product": {{- product | json -}},
      "formatted": {
        {%- for variant in product.variants -%}

          {%- liquid
            capture price
              render 'price-as-money', price: variant.price
            endcapture

            capture compare_at_price
              render 'price-as-money', price: variant.compare_at_price, show_money_with_currency: false
            endcapture

            capture unit_price
              render 'price-as-money', price: variant.unit_price, show_money_with_currency: false
            endcapture
          -%}
          "{{ variant.id }}":{"price":{{ price | json }}
            {%- if variant.compare_at_price and variant.compare_at_price > variant.price -%}
              ,"compareAtPrice":{{ compare_at_price | json -}}
            {%- endif -%}
            {%- if variant.unit_price_measurement -%}
              ,"unitPrice":{{ unit_price | json -}}
            {%- endif -%}
            {%- if variant.inventory_management != nil and variant.inventory_quantity <= 0 -%}
              ,"inventory":"none"
            {%- endif -%}
            {%- if variant.weight -%}
              ,"weight":{{ variant.weight | weight_with_unit: variant.weight_unit | json }}
            {%- endif -%}
          }{%- unless forloop.last %},{% endunless -%}
        {%- endfor -%}
      }
    }
  </script>

  {%- comment -%}
    Tabla de variantes - thead y tfoot estáticos, tbody dinámico
  {%- endcomment -%}
  {% if customer.b2b? %}
    {%- liquid
      assign can_order = true
      if customer.tags contains 'agente' or customer.tags contains 'main_contact' or customer.role == 'main_contact' or customer.metafields.upng-permission.allowOrder == true
        assign can_order = true
      else
        assign can_order = false
      endif
      
      assign can_see_prices = true
      if can_order and customer.metafields.upng-permission.verPrecios == true
        assign can_see_prices = true
      else
        assign can_see_prices = false
      endif
    -%}

    <table class="variant-table">
      <thead>
        <tr>
          <th scope="col" class="variant-table__header table-header-left">{{ 'custom.variant-table.color' | t }}</th>
          <th scope="col" class="variant-table__header visually-hidden">{{ 'custom.variant-table.variant-name' | t }}</th>
          <th scope="col" class="variant-table__header">{{ 'custom.variant-table.size' | t }}</th>
          {% if customer.tags contains 'agente' or customer.tags contains 'main_contact' or customer.role == 'main_contact' or customer.metafields['upng-permission'].verStock %}
            <th scope="col" class="variant-table__header" id="header_cell--stock">{{ 'custom.variant-table.stock' | t }}</th>
          {% endif %}
          <th scope="col" class="variant-table__header" id="header_cell--date">{{ 'custom.variant-table.next-arrival_html' | t }}</th>
          <th scope="col" class="variant-table__header" id="header_cell--notify">{{ 'custom.variant-table.notify-me' | t }}</th>
          <th scope="col" class="variant-table__header">
            {% if can_see_prices %}
              <span class="upng-price-wrapper--pvd">{{ 'custom.variant-table.discounted-price_html' | t }}</span>
            {% endif %}
          </th>
          {% if can_order %}
            <th scope="col" class="variant-table__header table-header-left">{{ 'custom.variant-table.quantity' | t }}</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {%- comment -%}
          Este tbody será reemplazado dinámicamente por JavaScript
        {%- endcomment -%}
      </tbody>
      <tfoot>
        <tr class="">
          <td colspan="100%">
            <div class="mt-2 mb-2">
              <button class="btn btn--primary btn--lg w-full js-actualizar-carrito" disabled>{{ 'custom.variant-table.add_to_cart' | t }}</button>
            </div>
          </td>
        </tr>
        <tr class="variant-table__last-row">
          <td colspan="100%">
            <div class="flex justify-between variant-table__total-container">
              <div class="flex justify-start items-center gap-theme">
                {% if can_order %}
                  <modal-opener class="no-js-hidden opener_inactive" id="clear_modal_opener" data-modal="modal-{{- product.id -}}-clear">
                    <button class="btn btn--sm btn--icon text-current tap-target text-error-text" aria-haspopup="dialog">
                      {% render 'icon-trash' %}
                      <span>{{ 'custom.variant-table.clear-all' | t }}</span>
                    </button>
                  </modal-opener>
                  <div class="variant-table__loader is-loading hidden"></div>
    
                  <a href="{{ routes.cart_url }}" aria-label="{{ 'custom.variant-table.view-cart' | t }}"
                    class="btn btn--secondary btn--sm variant-table__view-cart-button js-prod-link">
                    {{ 'custom.variant-table.view-cart' | t }}
                  </a>
                {% else %}
                {% endif %}
              </div>
              <div class="flex justify-end items-center gap-theme">
                {% if customer.b2b? -%}
                {% if customer.tags contains 'agente' or customer.tags contains 'main_contact' or customer.role == 'main_contact' or customer.metafields.upng-permission.verPrecios == true %}
                <div class="upng-price-wrapper--pvd">
                  <span class="variant-table__total">{{ 'custom.variant-table.subtotal' | t }}:</span>
                  <span class="variant-table__subtotal-value"
                    ><strong>{{ 0 | money }}</strong></span
                  >
                </div>
                {% endif %} 
                {% endif %} 
                <div class="flex flex-col items-start" style="width: fit-content; padding-right: 3rem;">
                  <span class="variant-table__total-items-value"><strong>0</strong></span>
                  <span class="variant-table__total">{{ 'custom.variant-table.total-items' | t }}</span>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </tfoot>
    </table>
  {% else %}
    <a class="btn btn--secondary w-full mt-8" href="{{settings.signup_page.url }}">{{ 'custom.variant-table.request-access' | t }}</a>
  {% endif %}
</upng-variant-picker>

{% if customer.b2b? %}
<div class="flex justify-center gap-2 pt-2 pb-2" style="background-color: rgb(245, 245, 245);">
  <div class="text-xs product-inventory__status" data-inventory-level="normal">{{- 'custom.availability.available' | t -}}</div>
  <div class="text-xs product-inventory__status" data-inventory-level="backordered">{{- 'custom.availability.next-arrival' | t -}}</div>
  <div class="text-xs product-inventory__status" data-inventory-level="low">{{- 'custom.availability.outlet' | t -}}</div>
  <div class="text-xs product-inventory__status" data-inventory-level="very_low">{{- 'custom.availability.not-available' | t -}}</div>
</div>
{% endif %}

<noscript>
  <div
    class="product-info__select"
    {% if product.has_only_default_variant %}
      hidden
    {% endif %}
  >
    <label class="label" for="variants-{{ section.id }}">
      {{- 'products.product.product_variants' | t -}}
    </label>
    <div class="select relative">
      <select class="select w-full" id="variants-{{ section.id }}" name="id" form="{{ product_form_id }}">
        {% comment %} {%- for variant in product.variants -%}
          <option
            value="{{ variant.id }}"
            {% if variant == current_variant %}
              selected
            {% endif %}
            {% if variant.available == false %}
              disabled
            {% endif %}
          >
            {{- variant.title -}}
            {%- if variant.available == false %} - {{ 'products.product.sold_out' | t }}{% endif %}
            - {{ variant.price | money | strip_html }}
          </option>
        {%- endfor -%} {% endcomment %}
      </select>
    </div>
  </div>
</noscript>
