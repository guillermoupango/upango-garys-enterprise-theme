{%- if section.index > 2 -%}
  <link rel="stylesheet" href="{{ 'featured-collection.css' | asset_url }}" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="{{ 'product.css' | asset_url }}" media="print" onload="this.media='all'">
{%- else -%}
  {{ 'featured-collection.css' | asset_url | stylesheet_tag }}
  {{ 'product.css' | asset_url | stylesheet_tag }}
{%- endif -%}

{%- if settings.card_hover_action == 'slideshow' -%}
  <script src="{{ 'product-card-image-slider.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- if settings.enable_quick_add -%}
  <link rel="stylesheet" href="{{ 'quick-add.css' | asset_url }}" media="print" onload="this.media='all'">
  <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'UPNG-variant-picker.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'custom-select.js' | asset_url }}" defer="defer"></script>
{%- endif -%}
<link rel="stylesheet" href="{{ 'modal.css' | asset_url }}">

{%- liquid
  assign show_view_all = section.settings.show_view_all

  assign carousel_desktop_small = ' md:auto-cols-3 lg:auto-cols-4 xl:auto-cols-5 small-cards-desktop'
  assign carousel_desktop_medium = ' sm:auto-cols-3 xl:auto-cols-4'
  assign carousel_desktop_large = ' sm:auto-cols-2 lg:auto-cols-3'

  assign grid_desktop_small = ' md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 small-cards-desktop'
  assign grid_desktop_medium = ' sm:grid-cols-3 xl:grid-cols-4'
  assign grid_desktop_large = ' sm:grid-cols-2 lg:grid-cols-3'

  if settings.prod_card_image_ratio == 'shortest'
    assign image_ratio = 0
    for product in product_list
      if product.featured_media.preview_image.aspect_ratio > image_ratio
        assign image_ratio = product.featured_media.preview_image.aspect_ratio
      endif
    endfor
  elsif settings.prod_card_image_ratio == 'tallest'
    assign image_ratio = 99
    for product in product_list
      if product.featured_media.preview_image.aspect_ratio < image_ratio
        assign image_ratio = product.featured_media.preview_image.aspect_ratio
      endif
    endfor
  else
    assign image_ratio = settings.prod_card_image_ratio
  endif

  assign color_scheme = section.settings.color_scheme
  assign bg_color = false

  if color_scheme == 'default'
    assign bg_color = settings.bg_color
  elsif color_scheme == '1'
    assign bg_color = settings.color_scheme_1_bg_grad | default: settings.color_scheme_1_bg
  elsif color_scheme == '2'
    assign bg_color = settings.color_scheme_2_bg_grad | default: settings.color_scheme_2_bg
  elsif color_scheme == '3'
    assign bg_color = settings.color_scheme_3_bg_grad | default: settings.color_scheme_3_bg
  endif

  if bg_color == settings.bg_color or bg_color == 'rgba(0,0,0,0)'
    assign bg_color = false
  endif
-%}

{%- capture slider_arrows -%}
<div class="slider-nav absolute top-middle end {% if settings.slider_show_arrows == 'hover' %}slider-nav--show-on-hover no-hover-hidden {% endif %}hidden md:block no-js-hidden">
  <button type="button" class="slider-nav__btn tap-target btn {{ settings.slider_button_style }} has-ltr-icon" name="next" aria-controls="slider-{{ section.id }}">
    <span class="visually-hidden">{{ 'general.slider.next' | t }}</span>
    {% render 'icon-chevron-right' %}
  </button>
  <button type="button" class="slider-nav__btn tap-target btn {{ settings.slider_button_style }} has-ltr-icon" name="prev" aria-controls="slider-{{ section.id }}">
    <span class="visually-hidden">{{ 'general.slider.previous' | t }}</span>
    {% render 'icon-chevron-left' %}
  </button>
</div>
{%- endcapture -%}

<div class="section">
  {%- if section.settings.title != blank -%}
    <div class="container">
      <div
        class="section__header items-center flex{% if section.settings.heading_align == 'text-center' %} flex-col text-center{% elsif section.settings.heading_align == 'text-end' %} flex-row-reverse flex-wrap{% else %} flex-row flex-wrap{% endif %} gap-x-theme"
        {% if settings.animations_enabled != 'disabled' %}
          data-cc-animate
        {% endif %}
        style="margin-bottom: 24px"
      >
        {%- if section.settings.title != blank -%}
          <h2 class="h4 mb-0 flex-auto section__heading {{ section.settings.heading_align }}">
            {{- section.settings.title | escape -}}
          </h2>
        {%- endif -%}
      </div>
    </div>
  {%- endif -%}

  <tabbed-content class="grow">
    <div class="tablist relative container overflow-hidden bg-theme-bg mb-2">
      <div
        class="tablist__scroller flex{% if section.settings.heading_align == 'text-center' %} justify-center text-center
        {% elsif section.settings.heading_align == 'text-end' %} justify-end flex-wrap
        {% else %} flex-row flex-wrap{% endif %} gap-x-theme
        {% unless section.settings.show_view_all %} pb-6{% endunless %}"
        role="tablist" style="margin: 1rem 0;"
      >
        {%- for block in section.blocks -%}
          {% liquid
            assign tab_collection = block.settings.tab_collection
            assign tab_title = block.settings.tab_title
            assign tab_layout = block.settings.layout
          %}

          <button
            type="button"
            style="margin: 0"
            class="tablist__tab font-bold product_list__tab flex"
            id="psearch-{{ tab_collection }}-tab"
            role="tab"
            {%- unless forloop.first %}
              tabindex="-1"
            {% endunless %}
            aria-controls="psearch-{{ tab_collection }}"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
          >
            {{ tab_title }}
          </button>
        {% endfor %}
      </div>
    </div>
    {%- for block in section.blocks -%}
      {% liquid
        assign tab_collection = block.settings.tab_collection
        assign product_list = blank
        if tab_collection != blank
          assign product_list = tab_collection.products
        endif

        assign tab_title = block.settings.tab_title
        assign card_size_mobile = block.settings.card_size_mobile
        assign card_size = block.settings.card_size
        assign products_to_show = block.settings.products_to_show
        assign tab_layout = block.settings.layout

        if card_size_mobile == 'small'
          assign carousel_mobile_cols = 'grid-flow-col auto-cols-2 small-cards-mobile'
          assign grid_mobile_cols = 'grid-cols-2 small-cards-mobile'
          if tab_layout == 'carousel_on_mobile'
            assign carousel_mobile_cols = carousel_mobile_cols | append: ' sm:grid-cols-2'
          endif
        else
          assign carousel_mobile_cols = 'grid-flow-col auto-cols-1'
          assign grid_mobile_cols = 'grid-cols-1'
        endif

        if tab_layout == 'carousel'
          assign carousel = true
          if card_size == 'small'
            assign grid_classes = carousel_mobile_cols | append: carousel_desktop_small
          elsif card_size == 'medium'
            assign grid_classes = carousel_mobile_cols | append: carousel_desktop_medium
          else
            assign grid_classes = carousel_mobile_cols | append: carousel_desktop_large
          endif

        elsif tab_layout == 'carousel_on_mobile'
          assign carousel = true
          if card_size == 'small'
            assign grid_classes = carousel_mobile_cols | append: grid_desktop_small
          elsif card_size == 'medium'
            assign grid_classes = carousel_mobile_cols | append: grid_desktop_medium
          else
            assign grid_classes = carousel_mobile_cols | append: grid_desktop_large
          endif

        else
          assign carousel = false
          if card_size == 'small'
            assign grid_classes = grid_mobile_cols | append: grid_desktop_small
          elsif card_size == 'medium'
            assign grid_classes = grid_mobile_cols | append: grid_desktop_medium
          else
            assign grid_classes = grid_mobile_cols | append: grid_desktop_large
          endif
        endif
      %}

      <div
        class="focus-inset"
        id="psearch-{{ tab_collection }}"
        role="tabpanel"
        tabindex="0"
        aria-labelledby="psearch-{{ tab_collection }}-tab"
        {% unless forloop.first %}
          hidden
        {% endunless %}
      >
        {%- if product_list != blank -%}
          {%- if show_view_all -%}
            <div class="container tab_collection_show_all mb-heading pt-2 {{ section.settings.heading_align }}">
              <a href="{{ tab_collection.url }}" class="link">{{ 'sections.featured_collection.view_all' | t }}</a>
            </div>
          {%- endif -%}
          {%- if carousel -%}
            <carousel-slider
              class="carousel block{% if section.settings.show_promo_info %} grow{% endif %}"
              inactive
              {% if tab_layout == 'carousel_on_mobile' %}
                disable-desktop="true"
              {% endif %}
            >
              <div class="{% unless section.settings.show_promo_info %}container relative{% endunless %} featured-collection-products">
                <div class="slider" id="slider-{{ section.id }}{{ forloop.index0 }}">
          {%- endif -%}
          {% unless tab_layout == 'parrilla' %}
            <div class="container main-products-grid products-grid-container" data-layout="grid">
              <ul
                class="{% if carousel %}slider__grid {% endif %}grid {{ grid_classes }}{% if section.settings.layout == 'carousel_on_mobile' and card_size_mobile == 'small' and settings.card_contain %} sm:gap-x-theme sm:gap-y-8{% else %} gap-x-theme gap-y-8{% endif %}{% if card_size_mobile == 'small' and settings.card_contain %} small__grid{% endif %}"
                role="list"
              >
                {%- for product in product_list limit: products_to_show -%}
                  <li
                    {% if carousel %}
                      class="slider__item"
                    {% endif -%}
                    {% if settings.animations_enabled != 'disabled' %}
                      data-cc-animate data-cc-animate-delay="{{ forloop.index | times: 0.07 }}s"
                    {% endif %}
                  >
                    {% render 'product-card',
                      product: product,
                      image_ratio: image_ratio,
                      show_highlight_product: section.settings.show_highlight_products
                    %}
                  </li>
                {%- endfor -%}
              </ul>
            </div>
          {% endunless %}
          {%- if carousel -%}
            </div>
            {%- if settings.slider_show_arrows != 'never' -%}
              {{ slider_arrows }}
            {%- endif -%}
            </div>
            {%- if settings.slider_show_arrows != 'never' -%}
              {{ slider_arrows }}
            {%- endif -%}
            </carousel-slider>
          {%- endif -%}

          {% if tab_layout == 'parrilla' %}
            <div class="container main-products-grid flex products-grid-container" data-layout="list">
              <ul class="grid w-full" role="list">
                {%- for product in product_list limit: products_to_show -%}
                  <li class="item_tab_parrilla">
                    {% render 'product-card', product: product %}
                  </li>
                {%- endfor -%}
              </ul>
            </div>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}
  </tabbed-content>
</div>

{% schema %}
{
  "name": "UPNG Product list tabs",
  "tag": "section",
  "class": "cc-featured-collection cc-product-card-grid",
  "settings": [
    {
      "type": "header",
      "content": "Section header"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Product list"
    },
    {
      "type": "select",
      "id": "heading_align",
      "label": "Heading alignment",
      "options": [
        {
          "value": "text-start",
          "label": "Left"
        },
        {
          "value": "text-center",
          "label": "Center"
        },
        {
          "value": "text-end",
          "label": "Right"
        }
      ],
      "default": "text-start"
    },
    {
      "type": "checkbox",
      "id": "show_highlight_products",
      "label": "Show highlight products",
      "info": "To highlight a particular product card, add a 'True or false' product metafield with the namespace and key 'theme.highlight'. See more settings in Theme Settings > Product cards > Highlighted cards.",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show \"View all\" link",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "tab",
      "settings": [
        {
          "type": "text",
          "id": "tab_title",
          "label": "Heading",
          "default": "Tab"
        },
        {
          "type": "header",
          "content": "Layout"
        },
        {
          "type": "collection",
          "id": "tab_collection",
          "label": "Collection"
        },
        {
          "type": "select",
          "id": "layout",
          "label": "Layout",
          "options": [
            {
              "value": "carousel",
              "label": "Carousel"
            },
            {
              "value": "carousel_on_mobile",
              "label": "Carousel on mobile"
            },
            {
              "value": "grid",
              "label": "Grid"
            },
            {
              "value": "parrilla",
              "label": "Parrilla"
            }
          ],
          "default": "carousel"
        },
        {
          "type": "select",
          "id": "card_size_mobile",
          "label": "Product card size on mobile",
          "options": [
            {
              "value": "small",
              "label": "Small"
            },
            {
              "value": "large",
              "label": "Large"
            }
          ],
          "default": "small"
        },
        {
          "type": "select",
          "id": "card_size",
          "label": "Product card size on large screens",
          "info": "For grid and carousel",
          "options": [
            {
              "value": "small",
              "label": "Small"
            },
            {
              "value": "medium",
              "label": "Medium"
            },
            {
              "value": "large",
              "label": "Large"
            }
          ],
          "default": "small"
        },
        {
          "type": "range",
          "id": "products_to_show",
          "label": "Maximum products to show",
          "min": 4,
          "max": 50,
          "step": 1,
          "default": 4
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "UPNG Product list tabs"
    }
  ],
  "disabled_on": {
    "templates": ["password"],
    "groups": ["aside"]
  }
}
{% endschema %}
